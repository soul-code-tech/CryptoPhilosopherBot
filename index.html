<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∏–ª–æ—Å–æ—Ñ –†—ã–Ω–∫–∞ ‚Äî –¢–æ—Ä–≥–æ–≤—ã–π –ë–æ—Ç v4.1</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f0f1a; color: #e0e0ff; padding: 20px; max-width: 1200px; margin: 0 auto; }
        h1, h2, h3 { color: #8a2be2; }
        .header { text-align: center; margin-bottom: 30px; }
        .section { background: #1a1a2e; padding: 20px; border-radius: 10px; margin-bottom: 25px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #2a2a40; padding: 15px; border-radius: 8px; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #3a3a5a; }
        th { background: #2a2a40; }
        tr:hover { background: #1e1e30; }
        .log-entry { background: #16213e; padding: 10px; margin: 5px 0; border-radius: 5px; font-family: monospace; }
        .deposit-section { text-align: center; margin: 20px 0; }
        input, button { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #4a4a7a; }
        button { background: #6a5acd; color: white; cursor: pointer; }
        button:hover { background: #8a2be2; }
        .progress-bar { height: 20px; background: #2a2a40; border-radius: 10px; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #ff6b6b, #4ecdc4); border-radius: 10px; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß† –§–∏–ª–æ—Å–æ—Ñ –†—ã–Ω–∫–∞ ‚Äî –¢–æ—Ä–≥–æ–≤—ã–π –ë–æ—Ç v4.1</h1>
        <p><em>–î—É–º–∞–µ—Ç, –∞ –Ω–µ —Å–ª–µ–¥—É–µ—Ç. –ß—É–≤—Å—Ç–≤—É–µ—Ç, –∞ –Ω–µ —Å—á–∏—Ç–∞–µ—Ç.</em></p>
    </div>

    <div class="section">
        <h2>üíº –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º</h2>
        <div class="deposit-section">
            <input type="number" id="depositAmount" placeholder="–°—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è" step="0.01" min="0.01">
            <button onclick="depositFunds()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
        </div>
        <div id="balanceDisplay">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: $0.00</div>
        <h3>üìä –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏</h3>
        <div id="openPositions">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="section">
        <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div>–°–¥–µ–ª–æ–∫ –≤—Å–µ–≥–æ</div>
                <div id="totalTrades">0</div>
            </div>
            <div class="stat-card">
                <div>Win Rate</div>
                <div id="winRate">0.0%</div>
            </div>
            <div class="stat-card">
                <div>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div>
                <div id="totalProfit">$0.00</div>
            </div>
            <div class="stat-card">
                <div>–ú–∞–∫—Å. –ø—Ä–æ—Å–∞–¥–∫–∞</div>
                <div id="maxDrawdown">0.0%</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üéØ –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–¥–µ–ª–æ–∫</h2>
        <div id="progressDisplay">–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π</div>
    </div>

    <div class="section">
        <h2>üìú –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫</h2>
        <table>
            <thead>
                <tr>
                    <th>–í—Ä–µ–º—è</th>
                    <th>–ú–æ–Ω–µ—Ç–∞</th>
                    <th>–¢–∏–ø</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–†–∞–∑–º–µ—Ä</th>
                    <th>–ü—Ä–∏–±—ã–ª—å</th>
                </tr>
            </thead>
            <tbody id="tradeHistory">
                <tr><td colspan="6">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>üß† –õ–æ–≥ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</h2>
        <div id="philosophyLog">–û–∂–∏–¥–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞...</div>
    </div>

    <script>
        let lastLog = '';

        async function updateState() {
            try {
                const response = await fetch('/api/state');
                const state = await response.json();

                // –ë–∞–ª–∞–Ω—Å
                document.getElementById('balanceDisplay').innerText = `–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: $${state.balance.toFixed(2)}`;

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                document.getElementById('totalTrades').innerText = state.stats.totalTrades;
                document.getElementById('winRate').innerText = `${state.stats.winRate.toFixed(1)}%`;
                document.getElementById('totalProfit').innerText = `$${state.stats.totalProfit.toFixed(2)}`;
                document.getElementById('maxDrawdown').innerText = `${state.stats.maxDrawdown.toFixed(1)}%`;

                // –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
                let positionsHtml = '';
                let hasOpen = false;
                for (const [coin, size] of Object.entries(state.positions)) {
                    if (size > 0) {
                        hasOpen = true;
                        positionsHtml += `<div>‚Üí ${coin}: ${size.toFixed(6)}</div>`;
                    }
                }
                document.getElementById('openPositions').innerHTML = hasOpen ? positionsHtml : '–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π';

                // –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–¥–µ–ª–æ–∫ (—É–ø—Ä–æ—â—ë–Ω–Ω–æ)
                let progressHtml = '';
                state.history.forEach(trade => {
                    if (trade.status === 'OPEN') {
                        progressHtml += `
                            <div><strong>${trade.coin}</strong></div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 50%;"></div>
                            </div>
                            <div>–¶–µ–ª—å: $${trade.targetPrice?.toFixed(2) || 'N/A'} | –°—Ç–æ–ø: $${trade.stopLossPrice?.toFixed(2) || 'N/A'}</div>
                        `;
                    }
                });
                document.getElementById('progressDisplay').innerHTML = progressHtml || '–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π';

                // –ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫
                let historyHtml = '';
                state.history.slice(-10).forEach(trade => {
                    const profit = trade.profitPercent ? `${(trade.profitPercent * 100).toFixed(2)}%` : '-';
                    historyHtml += `
                        <tr>
                            <td>${trade.timestamp}</td>
                            <td>${trade.coin}</td>
                            <td>${trade.type}</td>
                            <td>$${trade.entryPrice?.toFixed(2) || trade.price?.toFixed(2) || 'N/A'}</td>
                            <td>${trade.size?.toFixed(6) || '-'}</td>
                            <td>${profit}</td>
                        </tr>
                    `;
                });
                document.getElementById('tradeHistory').innerHTML = historyHtml || '<tr><td colspan="6">–ù–µ—Ç —Å–¥–µ–ª–æ–∫</td></tr>';

                // –õ–æ–≥ –∞–Ω–∞–ª–∏–∑–∞ (–∏–º–∏—Ç–∞—Ü–∏—è)
                const now = new Date().toLocaleTimeString();
                if (state.stats.totalTrades === 0 && lastLog !== 'init') {
                    document.getElementById('philosophyLog').innerHTML = `<div class="log-entry">[${now}] ‚ö™ –ù–µ—Ç —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π ‚Äî –∂–¥—ë–º...</div>`;
                    lastLog = 'init';
                } else if (state.stats.totalTrades > 0 && lastLog !== 'trade') {
                    document.getElementById('philosophyLog').innerHTML = `<div class="log-entry">[${now}] üíé –§–ò–õ–û–°–û–§–°–ö–ò–ô –í–´–í–û–î: –Ω–∞–π–¥–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–∫–æ–Ω–∞ –∏–Ω–µ—Ä—Ü–∏–∏ –∏ –ò–Ω—å-–Ø–Ω</div>`;
                    lastLog = 'trade';
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
            }
        }

        async function depositFunds() {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            if (isNaN(amount) || amount <= 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
                return;
            }

            try {
                const response = await fetch('/api/deposit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω! –ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: $${result.balance.toFixed(2)}`);
                    updateState();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.message);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(updateState, 5000);
        updateState(); // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
    </script>
</body>
</html>
